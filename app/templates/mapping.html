{% extends "base.html" %}

{% block title %}Source Mapping Configuration{% endblock %}

{% block extra_css %}
<style>
    .mapping-card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        transition: all 0.2s ease-in-out;
    }
    
    .mapping-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .mapping-form {
        background: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .column-mapping {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .mapping-type-badge {
        font-size: 0.75rem;
    }
    
    .example-data-table {
        font-size: 0.875rem;
    }
    
    .validation-error {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    .validation-success {
        color: #198754;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-gear me-2"></i>
                        Source Mapping Configuration
                    </h1>
                    <p class="text-muted mb-0">Configure how source-specific columns map to normalized processed data</p>
                </div>
                <button class="btn btn-primary" onclick="showCreateMappingModal()">
                    <i class="bi bi-plus-circle me-2"></i>
                    Add New Source
                </button>
            </div>
        </div>
    </div>

    <!-- Existing Mappings -->
    <div class="row" id="mappings-container">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        Current Source Mappings
                    </h5>
                </div>
                <div class="card-body">
                    <div id="mappings-list">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading source mappings...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Mapping Modal -->
<div class="modal fade" id="mappingModal" tabindex="-1" aria-modal="true" role="dialog" style="z-index: 1060;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg" style="background-color: white;">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-gear me-2"></i>
                    <span id="mappingModalLabel">Configure Source Mapping</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" style="background-color: white;">
                <form id="mappingForm">
                    <!-- Basic Information -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-light border-0">
                            <h6 class="mb-0 fw-semibold">
                                <i class="bi bi-info-circle me-2"></i>
                                Basic Information
                            </h6>
                            <small class="text-muted">Configure the source mapping details</small>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="sourceId" class="form-label fw-semibold">
                                        <i class="bi bi-hash me-1"></i>Source ID *
                                    </label>
                                    <input type="text" class="form-control" id="sourceId" name="source_id" required>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>Unique identifier for the source (e.g., "mybank")
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="displayName" class="form-label fw-semibold">
                                        <i class="bi bi-tag me-1"></i>Display Name *
                                    </label>
                                    <input type="text" class="form-control" id="displayName" name="display_name" required>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>Human-readable name for the source
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="description" class="form-label fw-semibold">
                                        <i class="bi bi-card-text me-1"></i>Description *
                                    </label>
                                    <input type="text" class="form-control" id="description" name="description" required>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>Brief description of the source
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="icon" class="form-label fw-semibold">
                                        <i class="bi bi-palette me-1"></i>Icon
                                    </label>
                                    <select class="form-select" id="icon" name="icon">
                                        <option value="bank">üè¶ Bank</option>
                                        <option value="credit-card">üí≥ Credit Card</option>
                                        <option value="shop">üõçÔ∏è Shop</option>
                                        <option value="truck">üöö Truck</option>
                                        <option value="file">üìÑ File</option>
                                    </select>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>Choose an icon for the source
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Required Column Mappings -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-light border-0">
                            <h6 class="mb-0 fw-semibold">
                                <i class="bi bi-table me-2"></i>
                                Column Mappings
                            </h6>
                            <small class="text-muted">Map source columns to target fields</small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="mappingsTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="border-0" style="width: 40%;">
                                                <i class="bi bi-arrow-right me-1"></i>Source Column *
                                            </th>
                                            <th class="border-0" style="width: 40%;">
                                                <i class="bi bi-arrow-left me-1"></i>Target Field *
                                            </th>
                                            <th class="border-0 text-center" style="width: 15%;">
                                                <i class="bi bi-tag me-1"></i>Type
                                            </th>
                                            <th class="border-0 text-center" style="width: 5%;">
                                                <i class="bi bi-gear me-1"></i>Actions
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="mappingsTableBody">
                                        <!-- Required mappings will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="mappingManager.addMappingRow()">
                            <i class="bi bi-plus-circle me-2"></i>
                            Add Column Mapping
                        </button>
                    </div>

                    <!-- Sample Data Processing -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light border-0">
                            <h6 class="mb-0 fw-semibold">
                                <i class="bi bi-file-earmark-text me-2"></i>
                                Sample Data Processing
                            </h6>
                            <small class="text-muted">Upload a sample file to generate metadata and populate column mappings</small>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="sampleDataFile" class="form-label fw-semibold">
                                        <i class="bi bi-upload me-1"></i>Upload Sample File
                                    </label>
                                    <input type="file" class="form-control" id="sampleDataFile" accept=".csv,.xlsx,.xls">
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>Supported formats: CSV, Excel (.xlsx, .xls)
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-gear me-1"></i>Process File
                                    </label>
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="mappingManager.processSampleFile()">
                                        <i class="bi bi-gear me-2"></i>
                                        Process File
                                    </button>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>Click to process the uploaded file
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3 p-3 bg-light rounded">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Existing metadata is automatically loaded when you enter a Source ID. Upload a new file to update the metadata.
                                </small>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-outline-success" id="restoreSettingsBtn" onclick="mappingManager.restoreSettings()" title="Restore the last saved configuration including sample data and column mappings">
                    <i class="bi bi-arrow-clockwise me-2"></i>
                    Restore
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn" onclick="mappingManager.saveMapping()">
                    <i class="bi bi-save me-2"></i>
                    Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-modal="true" role="dialog" style="z-index: 1060;">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg" style="background-color: white;">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" style="background-color: white;">
                <p>Are you sure you want to delete the mapping for <strong id="deleteSourceName"></strong>?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash me-2"></i>
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
class MappingManager {
    constructor() {
        this.currentMapping = null;
        this.optionalMappingIndex = 0;
        this.availableSourceColumns = [];
        this.lastSavedMapping = null;
        this.lastSavedSettings = null; // Store all settings including sample data
        this.init();
    }

    init() {
        this.loadMappings();
        this.setupEventListeners();
    }

    setupEventListeners() {
        // Form validation
        document.getElementById('mappingForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveMapping();
        });
        
        // Auto-load metadata when source ID changes
        const sourceIdInput = document.getElementById('sourceId');
        if (sourceIdInput) {
            sourceIdInput.addEventListener('blur', async () => {
                await this.loadMetadataForSourceId();
            });
        }
        
        // Handle custom column selection
        document.addEventListener('change', (e) => {
            if (e.target.tagName === 'SELECT' && e.target.value === 'custom') {
                this.handleCustomColumnSelection(e.target);
            }
        });
    }

    async loadMappings() {
        try {
            const response = await fetch('/api/mappings');
            if (response.ok) {
                const data = await response.json();
                this.displayMappings(data.mappings);
            } else {
                throw new Error('Failed to load mappings');
            }
        } catch (error) {
            this.showAlert('Failed to load mappings: ' + error.message, 'danger');
        }
    }

    displayMappings(mappings) {
        const container = document.getElementById('mappings-list');
        
        if (!mappings || Object.keys(mappings).length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="bi bi-gear text-muted" style="font-size: 4rem; opacity: 0.5;"></i>
                    </div>
                    <h4 class="text-muted mb-3">No Source Mappings</h4>
                    <p class="text-muted mb-4">Create your first source mapping to get started with data processing.</p>
                    <button class="btn btn-primary btn-lg" onclick="mappingManager.showCreateMappingModal()">
                        <i class="bi bi-plus-circle me-2"></i>
                        Create First Mapping
                    </button>
                </div>
            `;
            return;
        }

        let html = '<div class="row">';
        
        Object.entries(mappings).forEach(([sourceId, mapping]) => {
            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card mapping-card h-100 border-0 shadow-sm">
                        <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <i class="bi bi-${mapping.icon} fs-5"></i>
                                </div>
                                <div>
                                    <strong class="fw-semibold">${mapping.display_name}</strong>
                                    <br><small class="text-muted">${sourceId}</small>
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-sm rounded-start" onclick="mappingManager.editMapping('${sourceId}')" title="Edit mapping">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm rounded-end" onclick="mappingManager.deleteMapping('${sourceId}', '${mapping.display_name}')" title="Delete mapping">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text text-muted mb-3">${mapping.description}</p>
                            
                            <div class="mb-3">
                                <small class="text-muted fw-semibold">
                                    <i class="bi bi-check-circle me-1"></i>Required Columns:
                                </small>
                                <div class="mt-2">
                                    ${mapping.required_columns.map(col => 
                                        `<span class="badge bg-primary rounded-pill me-1 mb-1">${col}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            
                            ${mapping.optional_columns && mapping.optional_columns.length > 0 ? `
                                <div class="mb-3">
                                    <small class="text-muted fw-semibold">
                                        <i class="bi bi-plus-circle me-1"></i>Optional Columns:
                                    </small>
                                    <div class="mt-2">
                                        ${mapping.optional_columns.map(col => 
                                            `<span class="badge bg-secondary rounded-pill me-1 mb-1">${col}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="mt-3 pt-3 border-top">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Date Format</small>
                                        <span class="badge bg-light text-dark">${mapping.date_format}</span>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Amount Format</small>
                                        <span class="badge bg-light text-dark">${mapping.amount_format}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    async showCreateMappingModal() {
        this.currentMapping = null;
        await this.resetForm();
        document.getElementById('mappingModalLabel').textContent = 'Create New Source Mapping';
        

        
        // Remove existing modal and overlays
        const existingModal = document.getElementById('mappingModal');
        if (existingModal) {
            if (bootstrap.Modal.getInstance(existingModal)) {
                bootstrap.Modal.getInstance(existingModal).dispose();
            }
        }
        
        // Remove all modal backdrops and clean up body
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        // Initialize and show modal with static backdrop
        const modal = new bootstrap.Modal(existingModal, { 
            backdrop: 'static', 
            keyboard: true, 
            focus: true 
        });
        
        // Show modal
        modal.show();
        
        // Make backdrop fully opaque
        setTimeout(() => {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.style.opacity = '0.5';
            }
        }, 10);
        
        // Load existing sample files
        this.loadExistingSampleFiles();
        
        // Ensure restore button is visible
        this.updateRestoreButtonVisibility();
        
        // Auto-load metadata if source ID is pre-filled (e.g., from edit mode)
        const sourceId = document.getElementById('sourceId').value.trim();
        if (sourceId) {
            await this.loadMetadataForSourceId();
        }
    }

    async editMapping(sourceId) {
        try {
            // Load mapping configuration
            const mappingResponse = await fetch(`/api/mappings/${sourceId}`);
            if (!mappingResponse.ok) {
                throw new Error('Failed to load mapping configuration');
            }
            const data = await mappingResponse.json();
            this.currentMapping = data.mapping;
            
            // Load source metadata
            let sourceMetadata = null;
            try {
                const metadataResponse = await fetch(`/api/sample-data/sources/${sourceId}/metadata`);
                if (metadataResponse.ok) {
                    sourceMetadata = await metadataResponse.json();
                    this.availableSourceColumns = sourceMetadata.columns || [];
                }
            } catch (error) {
                console.log('No source metadata found, using default configuration');
                this.availableSourceColumns = [];
            }
            
            this.populateForm(data.mapping, sourceMetadata);
            document.getElementById('mappingModalLabel').textContent = `Edit Source Mapping: ${data.mapping.display_name}`;
            
            // Remove existing modal and overlays
            const existingModal = document.getElementById('mappingModal');
            if (existingModal) {
                if (bootstrap.Modal.getInstance(existingModal)) {
                    bootstrap.Modal.getInstance(existingModal).dispose();
                }
            }
            
            // Remove all modal backdrops and clean up body
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Initialize and show modal with static backdrop
            const modal = new bootstrap.Modal(existingModal, { 
                backdrop: 'static', 
                keyboard: true, 
                focus: true 
            });
            
            // Show modal
            modal.show();
            
            // Make backdrop fully opaque
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.style.opacity = '0.5';
                }
            }, 10);
            
            // Show feedback if metadata was loaded
            if (sourceMetadata && sourceMetadata.columns) {
                this.showAlert(`‚úÖ Loaded existing metadata for '${sourceId}' with ${sourceMetadata.columns.length} columns.`, 'success');
            }
        } catch (error) {
            this.showAlert('Failed to load mapping: ' + error.message, 'danger');
        }
    }

    deleteMapping(sourceId, displayName) {
        document.getElementById('deleteSourceName').textContent = displayName;
        this.currentMapping = { source_id: sourceId };
        
        // Remove existing modal and overlays
        const existingModal = document.getElementById('deleteModal');
        if (existingModal) {
            if (bootstrap.Modal.getInstance(existingModal)) {
                bootstrap.Modal.getInstance(existingModal).dispose();
            }
        }
        
        // Remove all modal backdrops and clean up body
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        // Initialize and show modal with static backdrop
        const modal = new bootstrap.Modal(existingModal, { 
            backdrop: 'static', 
            keyboard: true, 
            focus: true 
        });
        
        // Show modal
        modal.show();
        
        // Make backdrop fully opaque
        setTimeout(() => {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.style.opacity = '0.5';
            }
        }, 10);
    }

    async confirmDelete() {
        if (!this.currentMapping) return;
        
        try {
            const response = await fetch(`/api/mappings/${this.currentMapping.source_id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                this.showAlert('Mapping deleted successfully', 'success');
                this.loadMappings();
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            } else {
                throw new Error('Failed to delete mapping');
            }
        } catch (error) {
            this.showAlert('Failed to delete mapping: ' + error.message, 'danger');
        }
    }

    async loadMetadataForSourceId() {
        const sourceId = document.getElementById('sourceId').value.trim();
        
        if (!sourceId) {
            this.availableSourceColumns = [];
            this.clearMappingsTable();
            this.addDefaultMappings();
            return;
        }
        
        try {
            const response = await fetch(`/api/sample-data/sources/${sourceId}/metadata`);
            if (response.ok) {
                const metadata = await response.json();
                this.availableSourceColumns = metadata.columns || [];
                
                // Update the mappings table with available columns
                this.clearMappingsTable();
                this.addDefaultMappings();
                
                this.showAlert(`‚úÖ Loaded existing metadata for '${sourceId}' with ${this.availableSourceColumns.length} columns. You can now select from dropdowns.`, 'success');
            } else {
                // No existing metadata found - use common columns
                this.availableSourceColumns = [];
                this.clearMappingsTable();
                this.addDefaultMappings();
                console.log(`No existing metadata found for source: ${sourceId} - using common column defaults`);
            }
        } catch (error) {
            console.log('Error loading metadata:', error);
            this.availableSourceColumns = [];
            this.clearMappingsTable();
            this.addDefaultMappings();
        }
    }

    async resetForm() {
        document.getElementById('mappingForm').reset();
        this.clearMappingsTable();
        
        // Try to load source metadata for the selected source
        const sourceId = document.getElementById('sourceId').value;
        let availableSourceColumns = [];
        
        if (sourceId) {
            try {
                const response = await fetch(`/api/sample-data/sources/${sourceId}/metadata`);
                if (response.ok) {
                    const metadata = await response.json();
                    availableSourceColumns = metadata.columns || [];
                }
            } catch (error) {
                console.log('No source metadata found for new mapping');
            }
        }
        
        // Store available source columns
        this.availableSourceColumns = availableSourceColumns;
        
        this.addDefaultMappings();
        document.getElementById('saveBtn').disabled = false; // Enable save since validation is removed
    }

    populateForm(mapping, sourceMetadata = null) {
        // Basic info
        document.getElementById('sourceId').value = mapping.source_id;
        document.getElementById('displayName').value = mapping.display_name;
        document.getElementById('description').value = mapping.description;
        document.getElementById('icon').value = mapping.icon;
        
        // Store available source columns
        this.availableSourceColumns = sourceMetadata?.columns || [];
        
        // Store existing sample data if available
        if (mapping.example_data) {
            this.sampleData = {
                sample_data: mapping.example_data
            };
        }
        
        // Populate mappings table with source metadata
        this.populateMappingsTable(mapping, sourceMetadata);
        
        // Enable save button since validation is no longer required
        document.getElementById('saveBtn').disabled = false;
    }

    clearMappingsTable() {
        const tbody = document.getElementById('mappingsTableBody');
        tbody.innerHTML = '';
    }

    getCommonColumnsForType(type) {
        const commonColumns = {
            'date': [
                'Date', 'Transaction Date', 'Posting Date', 'Transaction Date', 
                'Date Posted', 'Transaction Date', 'Date Posted', 'Date Posted',
                'Transaction Date', 'Date Posted', 'Date Posted', 'Date Posted'
            ],
            'description': [
                'Description', 'Transaction Description', 'Memo', 'Description',
                'Transaction Description', 'Description', 'Description', 'Description',
                'Transaction Description', 'Description', 'Description', 'Description'
            ],
            'amount': [
                'Amount', 'Transaction Amount', 'Amount', 'Amount',
                'Transaction Amount', 'Amount', 'Amount', 'Amount',
                'Transaction Amount', 'Amount', 'Amount', 'Amount'
            ]
        };
        
        return commonColumns[type] || [];
    }

    handleCustomColumnSelection(selectElement) {
        const customColumn = prompt('Enter custom column name:');
        if (customColumn && customColumn.trim()) {
            // Create a new option with the custom column name
            const newOption = document.createElement('option');
            newOption.value = customColumn.trim();
            newOption.textContent = customColumn.trim();
            newOption.selected = true;
            
            // Replace the "custom" option with the new one
            const customOption = selectElement.querySelector('option[value="custom"]');
            if (customOption) {
                customOption.remove();
            }
            selectElement.appendChild(newOption);
        } else {
            // Reset to empty if user cancels
            selectElement.value = '';
        }
    }

    addDefaultMappings() {
        // Add the three core required mappings (Date, Description, Amount)
        this.addCoreMappingRow('', 'Date', 'date');
        this.addCoreMappingRow('', 'Description', 'description');
        this.addCoreMappingRow('', 'Amount', 'amount');
    }
    
    addCoreMappingRow(sourceColumn = '', targetColumn = '', type = 'required') {
        const tbody = document.getElementById('mappingsTableBody');
        const rowId = 'mapping-row-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        const typeLabel = type === 'date' ? 'Date' : 
                         type === 'description' ? 'Description' : 
                         type === 'amount' ? 'Amount' : 'Required';
        
        // Always use dropdown for better UX
        let sourceColumnInput;
        if (this.availableSourceColumns && this.availableSourceColumns.length > 0) {
            // Use available columns from metadata
            const options = this.availableSourceColumns.map(col => 
                `<option value="${col}" ${col === sourceColumn ? 'selected' : ''}>${col}</option>`
            ).join('');
            sourceColumnInput = `
                <select class="form-select form-select-sm" required>
                    <option value="">Select source column...</option>
                    ${options}
                </select>
            `;
        } else {
            // Use common column names as defaults
            const commonColumns = this.getCommonColumnsForType(type);
            const options = commonColumns.map(col => 
                `<option value="${col}" ${col === sourceColumn ? 'selected' : ''}>${col}</option>`
            ).join('');
            sourceColumnInput = `
                <select class="form-select form-select-sm" required>
                    <option value="">Select source column...</option>
                    ${options}
                    <option value="custom">+ Add Custom Column...</option>
                </select>
            `;
        }
        
        const row = `
            <tr id="${rowId}" data-core="true" class="align-middle">
                <td class="align-middle">
                    ${sourceColumnInput}
                </td>
                <td class="align-middle">
                    <input type="text" class="form-control form-control-sm" 
                           value="${targetColumn}" 
                           placeholder="e.g., Date, Description, Amount"
                           required>
                </td>
                <td class="text-center align-middle">
                    <span class="badge bg-primary rounded-pill">${typeLabel}</span>
                </td>
                <td class="text-center align-middle">
                    <span class="badge bg-secondary rounded-pill">Core</span>
                </td>
            </tr>
        `;
        
        tbody.insertAdjacentHTML('beforeend', row);
    }

    populateMappingsTable(mapping, sourceMetadata = null) {
        this.clearMappingsTable();
        
        // Add core required mappings (Date, Description, Amount)
        this.addCoreMappingRow(mapping.date_mapping.source_column, 'Date', 'date');
        this.addCoreMappingRow(mapping.description_mapping.source_column, 'Description', 'description');
        this.addCoreMappingRow(mapping.amount_mapping.source_column, 'Amount', 'amount');
        
        // Add additional required mappings
        if (mapping.optional_mappings) {
            mapping.optional_mappings.forEach(optMapping => {
                this.addMappingRow(optMapping.source_column, optMapping.target_field);
            });
        }
    }

    addMappingRow(sourceColumn = '', targetField = '') {
        const tbody = document.getElementById('mappingsTableBody');
        const rowId = 'mapping-row-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        // Always use dropdown for better UX
        let sourceColumnInput;
        if (this.availableSourceColumns && this.availableSourceColumns.length > 0) {
            // Use available columns from metadata
            const options = this.availableSourceColumns.map(col => 
                `<option value="${col}" ${col === sourceColumn ? 'selected' : ''}>${col}</option>`
            ).join('');
            sourceColumnInput = `
                <select class="form-select form-select-sm" required>
                    <option value="">Select source column...</option>
                    ${options}
                </select>
            `;
        } else {
            // Use common optional column names as defaults
            const commonOptionalColumns = [
                'Account Number', 'Account ID', 'Account', 'Account Number',
                'Category', 'Transaction Type', 'Type', 'Category',
                'Reference', 'Reference Number', 'Ref', 'Reference',
                'Balance', 'Running Balance', 'Balance', 'Balance'
            ];
            const options = commonOptionalColumns.map(col => 
                `<option value="${col}" ${col === sourceColumn ? 'selected' : ''}>${col}</option>`
            ).join('');
            sourceColumnInput = `
                <select class="form-select form-select-sm" required>
                    <option value="">Select source column...</option>
                    ${options}
                    <option value="custom">+ Add Custom Column...</option>
                </select>
            `;
        }
        
        const row = `
            <tr id="${rowId}" data-core="false" class="align-middle">
                <td class="align-middle">
                    ${sourceColumnInput}
                </td>
                <td class="align-middle">
                    <input type="text" class="form-control form-control-sm" 
                           placeholder="e.g., account_id, category"
                           value="${targetField}"
                           required>
                </td>
                <td class="text-center align-middle">
                    <span class="badge bg-info rounded-pill">Optional</span>
                </td>
                <td class="text-center align-middle">
                    <button type="button" class="btn btn-outline-danger btn-sm rounded-circle" onclick="mappingManager.removeMappingRow('${rowId}')" title="Remove this mapping">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    }

    removeMappingRow(rowId) {
        const row = document.getElementById(rowId);
        if (row) {
            // Check if this is a core mapping (Date, Description, Amount)
            const isCore = row.getAttribute('data-core') === 'true';
            if (isCore) {
                this.showAlert('Core mappings (Date, Description, Amount) cannot be removed.', 'warning');
                return;
            }
            row.remove();
            console.log(`Removed row with ID: ${rowId}`);
        } else {
            console.error(`Row with ID ${rowId} not found`);
            this.showAlert(`Error: Row not found. Please try again.`, 'danger');
        }
    }

    getMappingsFromTable() {
        const rows = document.querySelectorAll('#mappingsTableBody tr');
        
        // Use default format settings
        let dateFormat = 'MM/DD/YYYY'; // Default
        let amountFormat = 'USD'; // Default
        
        const mappings = {
            date_mapping: {
                source_column: '',
                target_field: 'date',
                mapping_type: 'date',
                required: true,
                date_format: dateFormat,
                description: 'Transaction date'
            },
            description_mapping: {
                source_column: '',
                target_field: 'description',
                mapping_type: 'description',
                required: true,
                description: 'Transaction description'
            },
            amount_mapping: {
                source_column: '',
                target_field: 'amount',
                mapping_type: 'amount',
                required: true,
                amount_format: amountFormat,
                description: 'Transaction amount'
            },
            optional_mappings: []
        };
        
        rows.forEach(row => {
            const sourceInput = row.querySelector('td:first-child input, td:first-child select');
            const targetInput = row.querySelector('td:nth-child(2) input');
            
            if (!sourceInput || !targetInput) return;
            
            const sourceColumn = sourceInput.value.trim();
            const targetColumn = targetInput.value.trim();
            const isCore = row.getAttribute('data-core') === 'true';
            
            if (sourceColumn && targetColumn) {
                if (isCore) {
                    // Handle core mappings (Date, Description, Amount)
                    if (targetColumn.toLowerCase() === 'date') {
                        mappings.date_mapping.source_column = sourceColumn;
                    } else if (targetColumn.toLowerCase() === 'description') {
                        mappings.description_mapping.source_column = sourceColumn;
                    } else if (targetColumn.toLowerCase() === 'amount') {
                        mappings.amount_mapping.source_column = sourceColumn;
                    }
                } else {
                    // Handle additional optional mappings
                    mappings.optional_mappings.push({
                        source_column: sourceColumn,
                        target_field: targetColumn,
                        mapping_type: 'optional',
                        required: false, // Additional mappings are optional
                        description: `Optional column: ${targetColumn}`
                    });
                }
            }
        });
        
        return mappings;
    }

    getFormData() {
        const form = document.getElementById('mappingForm');
        const formData = new FormData(form);
        
        // Basic validation
        const sourceId = formData.get('source_id');
        const displayName = formData.get('display_name');
        const description = formData.get('description');
        
        if (!sourceId || !displayName || !description) {
            this.showAlert('Please fill in all required fields', 'danger');
            return null;
        }
        
        // Get mappings from table
        const mappings = this.getMappingsFromTable();
        
        // Validate that all required mappings are filled
        if (!mappings.date_mapping.source_column || !mappings.description_mapping.source_column || !mappings.amount_mapping.source_column) {
            this.showAlert('Please fill in all required column mappings (Date, Description, Amount)', 'danger');
            return null;
        }
        
        // Validate that all additional mappings are filled
        const additionalMappings = mappings.optional_mappings || [];
        for (const mapping of additionalMappings) {
            if (!mapping.source_column || !mapping.target_field) {
                this.showAlert('Please fill in all additional column mappings', 'danger');
                return null;
            }
        }
        
        // Build the mapping object
        const mapping = {
            source_id: sourceId,
            display_name: displayName,
            description: description,
            icon: formData.get('icon') || 'file',
            date_mapping: mappings.date_mapping,
            description_mapping: mappings.description_mapping,
            amount_mapping: mappings.amount_mapping,
            optional_mappings: mappings.optional_mappings, // Include additional required mappings
            expected_columns: [
                mappings.date_mapping.source_column, 
                mappings.description_mapping.source_column, 
                mappings.amount_mapping.source_column,
                ...additionalMappings.map(m => m.source_column)
            ].filter(col => col), // Filter out empty columns
            required_columns: [
                mappings.date_mapping.source_column, 
                mappings.description_mapping.source_column, 
                mappings.amount_mapping.source_column,
                ...additionalMappings.map(m => m.source_column)
            ],
            default_date_format: mappings.date_mapping.date_format,
            default_amount_format: mappings.amount_mapping.amount_format,
            example_data: this.sampleData ? this.sampleData.sample_data || [] : []
        };
        

        
        return mapping;
    }

    async saveMapping() {
        const formData = this.getFormData();
        if (!formData) return;
        
        // Debug: Log the data being sent
        console.log('Saving mapping data:', formData);
        
        const saveBtn = document.getElementById('saveBtn');
        // Show loading state
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
        saveBtn.disabled = true;
        try {
            const url = this.currentMapping ? 
                `/api/mappings/${this.currentMapping.source_id}` : 
                '/api/mappings';
            const method = this.currentMapping ? 'PUT' : 'POST';
            
            console.log(`Sending ${method} request to: ${url}`);
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            console.log('Response status:', response.status);
            
            if (response.ok) {
                const result = await response.json();
                console.log('Save successful:', result);
                this.showAlert(result.message, 'success');
                this.loadMappings();
                bootstrap.Modal.getInstance(document.getElementById('mappingModal')).hide();
                // Store the last saved settings for restore
                this.lastSavedSettings = {
                    mapping: JSON.parse(JSON.stringify(formData)),
                    availableSourceColumns: [...this.availableSourceColumns],
                    sampleData: this.sampleData || null
                };
            } else {
                const error = await response.json();
                console.error('Save failed:', error);
                throw new Error(error.detail || 'Failed to save mapping');
            }
        } catch (error) {
            console.error('Save error:', error);
            this.showAlert('Failed to save mapping: ' + error.message, 'danger');
        } finally {
            // Restore button state
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    }

    showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    async restoreSettings() {
        if (this.lastSavedSettings) {
            try {
                // Store the settings we want to restore
                const settingsToRestore = this.lastSavedSettings;
                
                // Clear the form first
                await this.resetForm();
                
                // Restore all settings including sample data and metadata
                this.availableSourceColumns = [...settingsToRestore.availableSourceColumns];
                this.sampleData = settingsToRestore.sampleData;
                
                // Populate the form with saved settings
                this.populateForm(settingsToRestore.mapping, {columns: this.availableSourceColumns});
                
                // If there was sample data, also update the file input
                if (settingsToRestore.sampleData) {
                    // Note: We can't restore the actual file, but we can show that data was processed
                    const fileInput = document.getElementById('sampleDataFile');
                    if (fileInput) {
                        fileInput.value = ''; // Clear the file input
                    }
                }
                
                this.showAlert('All settings restored to last saved state!', 'success');
            } catch (error) {
                console.error('Error restoring settings:', error);
                this.showAlert('Error restoring settings: ' + error.message, 'danger');
            }
        } else {
            this.showAlert('No saved settings to restore. Save a configuration first to enable restore functionality.', 'warning');
        }
    }

    async processSampleFile() {
        const fileInput = document.getElementById('sampleDataFile');
        const file = fileInput.files[0];
        
        if (!file) {
            this.showAlert('Please select a file to process.', 'warning');
            return;
        }
        
        // Get the current source ID from the form
        const sourceIdInput = document.getElementById('sourceId');
        const sourceId = sourceIdInput ? sourceIdInput.value.trim() : 'temp_upload';
        
        if (!sourceId) {
            this.showAlert('Please enter a Source ID before processing the file.', 'warning');
            return;
        }
        
        // Show loading state
        const processBtn = document.querySelector('button[onclick="mappingManager.processSampleFile()"]');
        const originalText = processBtn.innerHTML;
        processBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
        processBtn.disabled = true;
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('source_id', sourceId);
            
            const response = await fetch('/api/mappings/process-sample-file', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Update the form with processed data
                this.updateFormFromSampleFile(result);
                
                this.showAlert('File processed successfully! Metadata and column mappings have been updated.', 'success');
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to process file');
            }
        } catch (error) {
            this.showAlert('Failed to process file: ' + error.message, 'danger');
        } finally {
            // Restore button state
            processBtn.innerHTML = originalText;
            processBtn.disabled = false;
        }
    }

    updateFormFromSampleFile(result) {
        // Store the processed data
        this.sampleData = result;
        
        // Update available source columns from metadata
        if (result.columns) {
            this.availableSourceColumns = result.columns;
        }
        
        // Clear existing mappings table and add core mappings with detected values
        this.clearMappingsTable();
        
        // Add core mappings with detected values or empty placeholders
        if (result.detected_mappings) {
            const mappings = result.detected_mappings;
            this.addCoreMappingRow(mappings.date_column || '', 'Date', 'date');
            this.addCoreMappingRow(mappings.description_column || '', 'Description', 'description');
            this.addCoreMappingRow(mappings.amount_column || '', 'Amount', 'amount');
        } else {
            // Add empty core mappings if no detection
            this.addCoreMappingRow('', 'Date', 'date');
            this.addCoreMappingRow('', 'Description', 'description');
            this.addCoreMappingRow('', 'Amount', 'amount');
        }
        
        // Add additional columns as new mappings (derive from columns minus detected mappings)
        if (result.columns && result.detected_mappings) {
            const detectedColumns = new Set(Object.values(result.detected_mappings));
            const additionalColumns = result.columns.filter(col => !detectedColumns.has(col));
            
            additionalColumns.forEach(column => {
                this.addMappingRow(column, column.toLowerCase().replace(/\s+/g, '_'));
            });
        }
        
        // Store sample data for backend validation
        if (result.sample_data) {
            this.sampleData.sample_data = result.sample_data;
        }
        
        this.showAlert('Sample data processed and saved! You can now modify the mappings as needed.', 'success');
    }
}

// Global functions for button onclick handlers
let mappingManager;

function showCreateMappingModal() {
    mappingManager.showCreateMappingModal();
}

function validateMapping() {
    mappingManager.validateMapping();
}

function saveMapping() {
    mappingManager.saveMapping();
}

function confirmDelete() {
    mappingManager.confirmDelete();
}

function addMappingRow() {
    mappingManager.addMappingRow('', '');
}

function removeMappingRow(rowId) {
    mappingManager.removeMappingRow(rowId);
}

async function restoreSettings() {
    await mappingManager.restoreSettings();
}

function processSampleFile() {
    mappingManager.processSampleFile();
}

function loadExistingSampleFile() {
    mappingManager.loadExistingSampleFile();
}

// Initialize the mapping manager
document.addEventListener('DOMContentLoaded', function() {
    mappingManager = new MappingManager();
});
</script>
{% endblock %} 